version: '3'

tasks:
  build:
    desc: Build docker container with tag
    requires:
      vars:
        - IMAGE
        - TAG
    vars:
      BUILD_DIR: '{{.BUILD_DIR | default "."}}'
    cmds:
      - >-
        nix develop --command
        docker build {{.BUILD_OPTS}} -t {{.IMAGE}}:{{.TAG}} {{.BUILD_DIR}}

  aws-login:
    internal: true
    requires:
      vars:
        - AWS_ACCOUNT_ID
        - AWS_REGION
    cmds:
      - >-
        nix develop --command
        aws ecr get-login-password --region {{.AWS_REGION}}
        | docker login --username AWS --password-stdin {{.AWS_ACCOUNT_ID}}.dkr.ecr.{{.AWS_REGION}}.amazonaws.com

  aws-build:
    desc: Build docker container for AWS
    requires:
      vars:
        - AWS_ACCOUNT_ID
        - AWS_REGION
        - IMAGE
        - TAG
    deps:
      - task: aws-login
    cmds:
      - task: build
        vars:
          BUILD_OPTS:
            ref: .BUILD_OPTS
          IMAGE: '{{.AWS_ACCOUNT_ID}}.dkr.ecr.{{.AWS_REGION}}.amazonaws.com/{{.IMAGE}}'
          TAG:
            ref: .TAG

  aws-deploy:
    desc: Push docker container to AWS
    requires:
      vars:
        - AWS_ACCOUNT_ID
        - AWS_REGION
        - IMAGE
        - TAG
    deps:
      - task: aws-login
      - task: aws-build
        vars:
          AWS_ACCOUNT_ID:
            ref: .AWS_ACCOUNT_ID
          AWS_REGION:
            ref: .AWS_REGION
          BUILD_OPTS:
            ref: .BUILD_OPTS
          IMAGE:
            ref: .IMAGE
          TAG:
            ref: .TAG
    cmds:
      - >-
        nix develop --command
        docker push {{.AWS_ACCOUNT_ID}}.dkr.ecr.{{.AWS_REGION}}.amazonaws.com/{{.IMAGE}}:{{.TAG}}
